<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpiar Tokens de Autenticaci√≥n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }
        .button:hover {
            background-color: #45a049;
        }
        .danger {
            background-color: #f44336;
        }
        .danger:hover {
            background-color: #da190b;
        }
        .log {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
        .warning {
            color: #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Reparar Autenticaci√≥n de Supabase</h1>
        <p>Esta herramienta te ayudar√° a limpiar tokens de autenticaci√≥n corruptos que pueden estar causando el error "Invalid Refresh Token".</p>
        
        <h2>Pasos para solucionar:</h2>
        <ol>
            <li><strong>Limpiar tokens:</strong> Haz clic en el bot√≥n de abajo para limpiar todos los tokens almacenados</li>
            <li><strong>Recargar p√°gina:</strong> Despu√©s de limpiar, recarga la p√°gina de tu aplicaci√≥n</li>
            <li><strong>Iniciar sesi√≥n nuevamente:</strong> Vuelve a iniciar sesi√≥n en tu aplicaci√≥n</li>
        </ol>
        
        <div style="margin: 20px 0;">
            <button class="button" onclick="clearAuthTokens()">üßπ Limpiar Tokens de Autenticaci√≥n</button>
            <button class="button danger" onclick="clearAllStorage()">‚ö†Ô∏è Limpiar TODO el Storage (Usar solo si es necesario)</button>
        </div>
        
        <div id="log" class="log">Presiona un bot√≥n para comenzar...</div>
        
        <h3>¬øQu√© hace esto?</h3>
        <ul>
            <li>Elimina tokens de autenticaci√≥n corruptos del localStorage</li>
            <li>Limpia datos de sesi√≥n del sessionStorage</li>
            <li>Remueve cookies relacionadas con Supabase</li>
            <li>Te permite empezar con una sesi√≥n limpia</li>
        </ul>
        
        <div style="margin-top: 30px; padding: 15px; background-color: #e3f2fd; border-radius: 5px;">
            <h4>üí° Despu√©s de usar esta herramienta:</h4>
            <p>1. Cierra esta pesta√±a<br>
            2. Ve a tu aplicaci√≥n (http://localhost:9002)<br>
            3. Recarga la p√°gina (Ctrl+F5 o Cmd+Shift+R)<br>
            4. Inicia sesi√≥n nuevamente</p>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearAuthTokens() {
            log('üßπ Iniciando limpieza de tokens de autenticaci√≥n...', 'info');
            let clearedCount = 0;
            
            try {
                // Limpiar localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('supabase.auth.token') || key.includes('supabase'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    log(`Removed localStorage: ${key}`, 'success');
                    clearedCount++;
                });
                
                // Limpiar sessionStorage
                const sessionKeysToRemove = [];
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && (key.startsWith('supabase.auth.token') || key.includes('supabase'))) {
                        sessionKeysToRemove.push(key);
                    }
                }
                
                sessionKeysToRemove.forEach(key => {
                    sessionStorage.removeItem(key);
                    log(`Removed sessionStorage: ${key}`, 'success');
                    clearedCount++;
                });
                
                // Limpiar cookies relacionadas con Supabase
                document.cookie.split(";").forEach(function(c) { 
                    const cookie = c.trim();
                    if (cookie.indexOf('supabase') === 0 || cookie.indexOf('sb-') === 0) {
                        const eqPos = cookie.indexOf("=");
                        const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                        log(`Cleared cookie: ${name}`, 'success');
                        clearedCount++;
                    }
                });
                
                if (clearedCount === 0) {
                    log('‚ÑπÔ∏è No se encontraron tokens de Supabase para limpiar', 'warning');
                } else {
                    log(`‚úÖ Limpieza completada! ${clearedCount} elementos eliminados`, 'success');
                    log('üîÑ Ahora ve a tu aplicaci√≥n y recarga la p√°gina', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Error durante la limpieza: ${error.message}`, 'error');
            }
        }
        
        function clearAllStorage() {
            if (confirm('‚ö†Ô∏è Esto eliminar√° TODOS los datos almacenados en el navegador para este sitio. ¬øEst√°s seguro?')) {
                log('üóëÔ∏è Limpiando TODO el storage...', 'warning');
                
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    log('‚úÖ LocalStorage y SessionStorage limpiados completamente', 'success');
                    log('üîÑ Recarga la p√°gina de tu aplicaci√≥n', 'info');
                } catch (error) {
                    log(`‚ùå Error limpiando storage: ${error.message}`, 'error');
                }
            }
        }
        
        // Mostrar informaci√≥n inicial
        log('üîç Herramienta de limpieza de tokens lista', 'info');
        log('üìç Dominio actual: ' + window.location.hostname, 'info');
    </script>
</body>
</html>